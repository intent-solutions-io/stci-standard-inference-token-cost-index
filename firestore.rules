rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Index data - read-only public access
    match /indices/{date} {
      allow read: if true;
      allow write: if false;
    }

    // Observations - read-only public access
    match /observations/{date} {
      allow read: if true;
      allow write: if false;
    }

    // Methodology - read-only public access
    match /methodology/{doc} {
      allow read: if true;
      allow write: if false;
    }

    // Email subscribers - write-only (no read from client)
    match /subscribers/{email} {
      allow read: if false;
      allow create: if request.resource.data.keys().hasAll(['email', 'createdAt'])
                    && request.resource.data.email is string
                    && request.resource.data.email.matches('.*@.*\\..*');
      allow update, delete: if false;
    }

    // Mail collection for Firebase Extension (Trigger Email)
    match /mail/{docId} {
      allow read: if false;
      allow create: if request.resource.data.keys().hasAll(['to', 'message']) &&
                    request.resource.data.to in ['jeremy@intentsolutions.io'] &&
                    request.resource.data.message is map &&
                    request.resource.data.message.keys().hasAny(['subject', 'text', 'html']);
      allow update, delete: if false;
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
